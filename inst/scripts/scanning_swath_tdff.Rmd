# Export the ScanningSWATH proteomics data in TDFF

Converting the protein and peptide quantification data from ScanningSWATH data
sets (as generated by the proteomics facility of the Charite Berlin) into TDFF
data modules. The data is imported from the facility's text file format into a
`SummarizedExperiment` that is subsequently exported to TDFF. For data import
the helper function below is used.

```{r}
#' @description
#'
#' Process the text files with protein or peptide values from Markus Ralser's
#' proteomics facility of Chartie Berlin. The text files have a custom format
#' that combines both row (protein) and column (sample) annotations in a
#' single two-dimensional text file structure.
#'
#' @param x `character(1)` with the file name.
#'
#' @param rd `integer(1)` defining the number of **columns** that are used
#'     to store the row data.
#'
#' @param cd `integer(1)` defining the number of **rows** in `x` that are
#'     used to store the sample annotations.
#'
#' @param rd_names `character(1)` defining the name of the column to be used
#'     as `rownames` for the `rowData`. Defaults to `rd_names = "Protein.Group"`
#'     which works if `x` contains protein abundances. For peptide abundances
#'     `rd_names = "Precursor.Id"` should be used instead.
#'
#' @return `SummarizedExperiment` with the data.
#'
#' @author Johannes Rainer
getSummarizedExperiment <- function(x, rd = 29, cd = 61,
                                    rd_names = "Protein.Group") {
    data <- read.table(x, sep = "\t", quote = "", comment.char = "")
    ## rowdata
    rowd <- data[seq(cd + 1L, nrow(data)), seq_len(rd)]
    colnames(rowd) <- data[1, seq_len(rd)]
    tf <- tempfile()
    write.table(rowd, file = tf, quote = FALSE, sep = "\t", col.names = TRUE,
                row.names = FALSE)
    rowd <- read.table(tf, sep = "\t", header = TRUE, check.names = FALSE)
    rownames(rowd) <- rowd[, rd_names]
    ## coldata
    cold <- data[seq(2L, cd), seq(rd + 1L, ncol(data))]
    colnames(cold) <- data[1, seq(rd + 1L, ncol(data))]
    rownames(cold) <- data[seq(2L, cd), 1L]
    write.table(t(cold), file = tf, quote = FALSE, sep = "\t", col.names = TRUE,
                row.names = TRUE)
    cold <- read.table(tf, sep = "\t", header = TRUE, check.names = FALSE)
    cold <- data.frame(sample_id = rownames(cold), cold)
    ## data
    ass <- data[seq(cd + 1L, nrow(data)), seq(rd + 1L, ncol(data))]
    ass <- as.matrix(as.data.frame(lapply(ass, as.numeric)))
    colnames(ass) <- rownames(cold)
    rownames(ass) <- rownames(rowd)
    SummarizedExperiment(assays = list(ass), rowData = rowd, colData = cold)
}

```

Loading the required packages.

```{r}
library(SummarizedExperiment)
library(tidyfr)
library(readxl)
```

## Exporting the protein-level data

Extracting the protein-level data from the original data files and assigning the
original CHRIS AIDs to the individual samples.

```{r}
dr <- paste0("/home/jo/data/CHRIS/proteomics-ScanningSWATH/",
             "40-0010_PeterPramstaller-EURAC-CHRIS/",
             "r_i2PP04pro_40-0010_wPOOL_na40knn9gr_MP_2022-02-14_23h12m/")

prot <- getSummarizedExperiment(
    paste0(dr, "proDataMat_WR_40-0010_2022-02-14_23h12m.txt"),
    rd = 29, cd = 61)

## Assign AIDs
aid_mapping <- as.data.frame(read_xlsx(paste0(dr, "AR233_sent.xlsx")))
idx <- match(prot$barcode.aliquot, aid_mapping$aliquot_barcode)
prot$AID <- aid_mapping$barcode_participant[idx]
```

Prepare the data for export as a TDFF module. Selected column annotations are
also extracted and exported.

```{r}
dta <- data(prot, assayNames = 1, labelPrefix = "x0sw")
dta$aid <- prot$AID

cols <- c("File.Name", "Date", "Inst", "Inj", "Plate", "Sample.Name",
          "container", "MS_Batch", "SP_Batch")
cd <- as.data.frame(colData(prot)[, cols])
cd$Inst <- factor(cd$Inst)
cd$Plate <- factor(cd$Plate)
cd$container <- factor(cd$container)
cd$MS_Batch <- factor(cd$MS_Batch)
cd$SP_Batch <- factor(cd$SP_Batch)
colnames(cd) <- paste0("x0sw", seq(ncol(dta), length.out = length(cols)))

dta <- cbind(dta, cd)

## Remove QC samples
dta_qc <- dta[dta$aid == "POOL", ]
```

Add and define the labels.

```{r}
lbls <- labels_from_data(dta)
lbls$description <- c(rowData(prot)$Protein.Group, cols)
lbls$long_description <- c(
    rowData(prot)$First.Protein.Description, cols)

## Add additional info.
rcols <- c("PeptideNN", "PeptideNames", "Protein.Ids", "Protein.Names", "Genes",
           "Modified.Sequence", "Stripped.Sequence", "Precursor.Id")
rd <- as.data.frame(rowData(prot)[, rcols])
dummy <- data.frame(matrix(ncol = ncol(rd), nrow = length(cols)))
colnames(dummy) <- colnames(rd)
rd <- rbind(rd, dummy)
lbls <- cbind(lbls, rd)

lbls$date_first_added <- "2023-03-06"
lbls$date_last_changed <- format(Sys.time(), "%Y-%m-%d")


library(CompMetaboTools)
## Add also CV.
cvs <- lapply(dta_qc[, seq(2, length.out = nrow(prot))],
              function(z) {
                  rsd(2^z)
              })
cvs <- unlist(cvs)
lbls$cv_qc_chris <- c(cvs, rep(NA_real_, length(cols)))
```

Define also label groups for protein abundances and general metadata.

```{r}
grps <- data.frame(group = "metadata", label = lbls$label)
grps[seq_len(nrow(prot)), "group"] <- "protein_abundance"
grplbls <- data.frame(group = c("metadata", "protein_abundance"),
                      description = c("Sample and plate information",
                                      "Protein abundance (log2 scale)"))
```

Next we export the full data set.

```{r}
export_tdf(
    name = "chris_scanningswath_proteins_full",
    description = paste0("CHRIS ScanningSWATH-based plasma proteomics ",
                         "data; full data set including QC samples."),
    version = "1.0.0.0", date = "2022-02-14",
    data = dta, groups = grps, grp_labels = grplbls, labels = lbls)
```

Also exporting the data without the QC samples.

```{r}
dta <- dta[dta$aid != "POOL", ]
export_tdf(
    name = "chris_scanningswath_proteins",
    description = paste0("CHRIS ScanningSWATH-based plasma proteomics ",
                         "data."),
    version = "1.0.0.0", date = "2022-02-14",
    data = dta, groups = grps, grp_labels = grplbls, labels = lbls)
```

Check that the data is correct.

```{r}
valid_data_module("chris_scanningswath_proteins")
valid_data_module("chris_scanningswath_proteins_full")
```

## Exporting the peptide-level data

We next import the peptide-level data and export also that as a TDFF module.

```{r}
pept <- getSummarizedExperiment(
    paste0(dr, "pepDataMat_WR_40-0010_2022-02-14_23h34m.txt"),
    rd = 34, cd = 61, rd_names = "Precursor.Id")

## Assign AIDs
idx <- match(pept$barcode.aliquot, aid_mapping$aliquot_barcode)
pept$AID <- aid_mapping$barcode_participant[idx]

```

```{r}
dta <- data(pept, assayNames = 1, labelPrefix = "x0swx")
dta$aid <- pept$AID

cols <- c("File.Name", "Date", "Inst", "Inj", "Plate", "Sample.Name",
          "container", "MS_Batch", "SP_Batch")
cd <- as.data.frame(colData(pept)[, cols])
cd$Inst <- factor(cd$Inst)
cd$Plate <- factor(cd$Plate)
cd$container <- factor(cd$container)
cd$MS_Batch <- factor(cd$MS_Batch)
cd$SP_Batch <- factor(cd$SP_Batch)
colnames(cd) <- paste0("x0swx", seq(ncol(dta), length.out = length(cols)))

dta <- cbind(dta, cd)

## Remove QC samples
dta_qc <- dta[dta$aid == "POOL", ]
```

Add and define the labels.

```{r}
lbls <- labels_from_data(dta)
lbls$description <- c(rownames(rowData(pept)), cols)
lbls$long_description <- c(rowData(pept)$First.Protein.Description, cols)

## Add additional info.
rcols <- c("Protein.Group", "Protein.Ids", "Protein.Names", "Genes",
           "Modified.Sequence", "Stripped.Sequence", "Precursor.Id")
rd <- as.data.frame(rowData(pept)[, rcols])
dummy <- data.frame(matrix(ncol = ncol(rd), nrow = length(cols)))
colnames(dummy) <- colnames(rd)
rd <- rbind(rd, dummy)
lbls <- cbind(lbls, rd)

lbls$date_first_added <- "2023-03-06"
lbls$date_last_changed <- format(Sys.time(), "%Y-%m-%d")

## Add also CV.
cvs <- lapply(dta_qc[, seq(2, length.out = nrow(pept))],
              function(z) {
                  rsd(2^z)
              })
cvs <- unlist(cvs)
lbls$cv_qc_chris <- c(cvs, rep(NA_real_, length(cols)))
```

Define also label groups for protein abundances and general metadata.

```{r}
grps <- data.frame(group = "metadata", label = lbls$label)
grps[seq_len(nrow(pept)), "group"] <- "peptide_abundance"
grplbls <- data.frame(group = c("metadata", "peptide_abundance"),
                      description = c("Sample and plate information",
                                      "Peptide abundance (log2 scale)"))
```

Next we export the full data set.

```{r}
export_tdf(
    name = "chris_scanningswath_peptides_full",
    description = paste0("CHRIS ScanningSWATH-based peptide-level plasma ",
                         "proteomics data; full data set including QC ",
                         "samples."),
    version = "1.0.0.0", date = "2022-02-14",
    data = dta, groups = grps, grp_labels = grplbls, labels = lbls)
```

Also exporting the data without the QC samples.

```{r}
dta <- dta[dta$aid != "POOL", ]
export_tdf(
    name = "chris_scanningswath_peptides",
    description = paste0("CHRIS ScanningSWATH-based peptide-lelvel plasma ",
                         "proteomics data."),
    version = "1.0.0.0", date = "2022-02-14",
    data = dta, groups = grps, grp_labels = grplbls, labels = lbls)
```

Check that the data is correct.

```{r}
valid_data_module("chris_scanningswath_peptides")
valid_data_module("chris_scanningswath_peptides_full")

```


## Exporting the raw peptide-level data

In addition to the two data sets exported above (that are processed following
the *method04* which includes knn-based imputation, normalization and batch
correction) we are exporting next a data set with the *real* raw peptide
concentrations. In the respective data set (processed using *method00*) only bad
quality samples and peptides were removed.

We next import the peptide-level data and export also that as a TDFF module.

```{r}
dr <- paste0("/home/jo/data/CHRIS/proteomics-ScanningSWATH/",
             "40-0010_PeterPramstaller-EURAC-CHRIS/",
             "r_i2PP00pep_40-0010_Analyt_PL3_2022-02-15_14h08m/")

raw <- getSummarizedExperiment(
    paste0(dr, "pepDataMat_WR_40-0010_2022-02-15_14h08m.txt"),
    rd = 32, cd = 61, rd_names = "Precursor.Id")

## Assign AIDs
idx <- match(raw$barcode.aliquot, aid_mapping$aliquot_barcode)
raw$AID <- aid_mapping$barcode_participant[idx]

```

```{r}
dta <- data(raw, assayNames = 1, labelPrefix = "x0swr")
dta$aid <- raw$AID

cols <- c("File.Name", "Date", "Inst", "Inj", "Plate", "Sample.Name",
          "container", "MS_Batch", "SP_Batch", "sample_id", "exclude")
cd <- as.data.frame(colData(raw)[, cols])
cd$Inst <- factor(cd$Inst)
cd$Plate <- factor(cd$Plate)
cd$container <- factor(cd$container)
cd$MS_Batch <- factor(cd$MS_Batch)
cd$SP_Batch <- factor(cd$SP_Batch)
colnames(cd) <- paste0("x0swr", seq(ncol(dta), length.out = length(cols)))

dta <- cbind(dta, cd)

```

Add and define the labels.

```{r}
lbls <- labels_from_data(dta)
lbls$description <- c(rownames(rowData(raw)), cols)
lbls$long_description <- c(rowData(raw)$First.Protein.Description, cols)

## Add additional info.
rcols <- c("Protein.Group", "Protein.Ids", "Protein.Names", "Genes",
           "Modified.Sequence", "Stripped.Sequence", "Precursor.Id")
rd <- as.data.frame(rowData(raw)[, rcols])
dummy <- data.frame(matrix(ncol = ncol(rd), nrow = length(cols)))
colnames(dummy) <- colnames(rd)
rd <- rbind(rd, dummy)
lbls <- cbind(lbls, rd)

lbls$date_first_added <- "2023-03-06"
lbls$date_last_changed <- format(Sys.time(), "%Y-%m-%d")

```

Define also label groups for protein abundances and general metadata.

```{r}
grps <- data.frame(group = "metadata", label = lbls$label)
grps[seq_len(nrow(raw)), "group"] <- "peptide_abundance"
grplbls <- data.frame(group = c("metadata", "peptide_abundance"),
                      description = c("Sample and plate information",
                                      "Peptide abundance (log2 scale)"))
```

Next we export the full data set.

```{r}
export_tdf(
    name = "chris_scanningswath_peptides_raw",
    description = paste0("CHRIS ScanningSWATH-based peptide-level plasma ",
                         "proteomics data; full data set including all QCs ",
                         "samples. Raw intensities (log2) with only minimal ",
                         "data processing (method00, i.e. only problematic ",
                         "samples and peptides removed)."),
    version = "1.0.0.0", date = "2022-02-14",
    data = dta, groups = grps, grp_labels = grplbls, labels = lbls)
```


## Removing participants from the various data sets

The version exported above contains the full data. We next exclude dropped-out
participants.

```{r}
rem <- readLines("/home/jo/data/CHRIS/exclude_set/excluded_participants.txt")
rem <- c(rem, readLines("/home/jo/data/CHRIS/exclude_set/2022-11-15.txt"))
rem <- c(rem, readLines("/home/jo/data/CHRIS/exclude_set/2023-01-17.txt"))
rem <- rem[-grep("^#", rem)]
mdl <- data_module("chris_scanningswath_proteins", "1.0.0.0", ".")
remove_participants(mdl, rem)

mdl <- data_module("chris_scanningswath_proteins_full", "1.0.0.0", ".")
remove_participants(mdl, rem)

mdl <- data_module("chris_scanningswath_peptides", "1.0.0.0", ".")
remove_participants(mdl, rem)

mdl <- data_module("chris_scanningswath_peptides_full", "1.0.0.0", ".")
remove_participants(mdl, rem)

mdl <- data_module("chris_scanningswath_peptides_raw", "1.0.0.0", ".")
remove_participants(mdl, rem)

```

# Session information

```{r}
sessionInfo()
```
